#!/usr/bin/env bats

load wvtest.sh

setup_file() {
    # Don't pollute current dir
    cd "$BATS_TEST_TMPDIR"
    create_dummy
}

@test "Exiton" {
    ./script -t '' --exiton=Hello --remote-cmd="echo Hello; cat"
}

@test "Expect send" {
    ./script -t '' --expect=question --send="answer\n" \
           --remote-cmd='echo question; read x; echo $x > output'
    grep answer output
}

@test "Expect regexp send" {
    ./script -t '' --expect-re=q..st..n --send="answer\n" \
           --remote-cmd='echo question; read x; echo $x > output'
    grep answer output
}

@test "Expect sendcont" {
    ./script -t '' --expect=More --sendcont="\n" \
           --remote-cmd='seq 100|more --exit-on-eof'
}

@test "Expect vs exiton priority" {
    ./script -t '' --expect="#" --sendcont="exit\n#" --exiton="exit" \
           --remote-cmd='echo -n "#"; cat' | tee output
    test "$(grep exit output | wc -l )" -eq 1
}
