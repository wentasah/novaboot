#!/usr/bin/env bats

load wvtest.sh

setup() {
    # Don't pollute current dir
    cd "$BATS_TEST_TMPDIR"
}

@test "Simple script" {
    create_dummy
    ./script --dump > dump
    diff -u - dump <<EOF
kernel
file
EOF
}

@test "--append" {
    create_dummy
    ./script --dump --append 1 --append 2 > dump
    diff -u - dump <<EOF
kernel 1 2
file
EOF
}

@test "Line continuation" {
    (echo "load line1 \\"; echo " line2")|novaboot --dump > dump
    diff -u - dump <<EOF
line1 line2
EOF
}

@test "--scriptmod" {
    create_dummy
    ./script --scriptmod="s/e/3/g" --dump > dump
    diff -u - dump <<EOF
k3rn3l
fil3
EOF
}

@test "--kernel" {
    create_script <<EOF
load kernel arg1 arg2
load file farg11
EOF
    ./script -k new --dump > dump
    diff -u - dump <<EOF
new arg1 arg2
file farg11
EOF
}

@test "--bender" {
    create_dummy
    ./script --gen-only --bender --dump > dump
    diff -u - dump <<EOF
bin/boot/bender
kernel
file
EOF
}

@test "--chainloader" {
    create_dummy
    ./script --chainloader=chain1 -chainloader='chain2 arg' --dump > dump
    diff -u - dump <<EOF
chain1
chain2 arg
kernel
file
EOF
}

@test "Heredoc" {
    create_script <<EOF
load file <<XXX
load inside heredoc
XXX
EOF
    ./script --dump > dump
    diff -u - dump <<EOF
file
EOF
}

@test "Load without file" {
    ! novaboot <<EOF
load
EOF
}

@test "Heredoc without file" {
    ! novaboot <<EOF
load <<XXX
inside heredoc
XXX
EOF
}

@test "Run keyword" {
    echo run echo ahoj|novaboot -t '' > output
    grep "^ahoj$" output
}
